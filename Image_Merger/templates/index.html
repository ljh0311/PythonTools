<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Feature Merger - Web Edition</title>
    <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" />
    <style>
      :root {
        --primary-color: #4361ee;
        --primary-dark: #3046c1;
        --secondary-color: #2d3748;
        --accent-color: #00b4d8;
        --success-color: #06d6a0;
        --danger-color: #ef476f;
        --background-color: #f8fafc;
        --card-bg: #ffffff;
        --text-primary: #2d3748;
        --text-secondary: #64748b;
        --border-radius: 1rem;
        --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --transition: all 0.3s ease;
      }

      [data-theme="dark"] {
        --background-color: #1a1b1e;
        --card-bg: #2d2e32;
        --text-primary: #e2e8f0;
        --text-secondary: #a0aec0;
      }

      /* Update existing styles with better contrast */
      .text-muted {
        color: var(--text-secondary) !important;
      }

      .form-check-label {
        color: var(--text-primary);
      }

      .btn-outline-primary {
        color: var(--primary-color);
      }

      .btn-outline-primary:hover {
        color: #ffffff;
      }

      /* Dark mode toggle button */
      .theme-toggle {
        background: transparent;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
        transition: var(--transition);
        margin-left: 1rem;
      }

      .theme-toggle:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
      }

      [data-theme="dark"] .theme-toggle {
        border-color: var(--text-primary);
        color: var(--text-primary);
      }

      [data-theme="dark"] .theme-toggle:hover {
        background: var(--text-primary);
        color: var(--card-bg);
      }

      /* Update loading styles for better contrast */
      .loading {
        background: var(--card-bg);
        color: var(--text-primary);
      }

      /* Update alert styles for better contrast */
      .alert-info {
        color: var(--primary-color);
      }

      [data-theme="dark"] .alert-info {
        color: #90cdf4;
      }

      .alert-danger {
        background: rgba(239, 71, 111, 0.1);
        color: var(--danger-color);
      }

      [data-theme="dark"] .alert-danger {
        background: rgba(239, 71, 111, 0.2);
        color: #ff8ba7;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-primary);
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        min-height: 100vh;
      }

      .navbar {
        background: var(--card-bg);
        box-shadow: var(--box-shadow);
        padding: 1rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }

      .navbar-brand {
        color: var(--primary-color) !important;
        font-weight: 700;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
      }

      .navbar-brand .badge {
        background: var(--primary-color);
        color: white;
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
        font-weight: 500;
      }

      .navbar .nav-link {
        color: var(--text-secondary) !important;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: var(--transition);
      }

      .navbar .nav-link:hover {
        color: var(--primary-color) !important;
        background: rgba(67, 97, 238, 0.05);
      }

      .navbar-toggler {
        border: none;
        padding: 0.5rem;
        color: var(--text-primary);
      }

      .navbar-toggler:focus {
        box-shadow: none;
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
      }

      .container {
        max-width: 1400px;
        padding: 2rem;
      }

      .card {
        background: var(--card-bg);
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 2rem;
        overflow: hidden;
      }

      .card-header {
        background: var(--card-bg);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1.1rem;
      }

      .card-body {
        padding: 1.5rem;
      }

      .form-label {
        color: var(--text-primary);
        font-weight: 500;
        margin-bottom: 0.75rem;
      }

      .form-control {
        border: 2px solid #e2e8f0;
        border-radius: 0.75rem;
        padding: 0.75rem 1rem;
        transition: var(--transition);
        background: #f8fafc;
      }

      .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
      }

      .btn {
        border-radius: 0.75rem;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: var(--transition);
      }

      .btn-primary {
        background: var(--primary-color);
        border: none;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
      }

      .btn-outline-primary {
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
      }

      .btn-outline-primary:hover {
        background: var(--primary-color);
        transform: translateY(-2px);
      }

      .thumbnail-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: var(--border-radius);
      }

      .thumbnail-item {
        position: relative;
      }
      .delete-thumbnail {
        display: none;
        z-index: 10;
      }
      .thumbnail-item:hover .delete-thumbnail {
        display: block;
      }
      .delete-result {
        opacity: 0;
        transition: opacity 0.2s;
      }
      .preview-container:hover .delete-result {
        opacity: 1;
      }
      .image-info {
        font-size: 0.85rem;
        margin-top: 0.5rem;
        padding: 0.5rem;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 0.5rem;
      }
      .image-info .badge {
        font-size: 0.75rem;
        margin-right: 0.25rem;
      }
      [data-theme="dark"] .image-info {
        background: rgba(255, 255, 255, 0.05);
      }

      .image-thumbnail {
        width: 100%;
        height: 160px;
        object-fit: cover;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
      }

      .custom-range {
        height: 6px;
        border-radius: 3px;
        background: #e2e8f0;
      }

      .custom-range::-webkit-slider-thumb {
        width: 20px;
        height: 20px;
        background: var(--primary-color);
        border: 3px solid #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: var(--transition);
      }

      .custom-range::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }

      .features-container {
        background: #f8fafc;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-top: 2rem;
      }

      .features-container h5 {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 1rem;
      }

      .alert-info {
        background: rgba(67, 97, 238, 0.1);
        border: none;
        border-radius: var(--border-radius);
        color: var(--primary-color);
      }

      .preview-container {
        background: #f8fafc;
        border-radius: var(--border-radius);
        padding: 2rem;
        margin: 1.5rem 0;
        text-align: center;
      }

      .preview-image {
        max-width: 100%;
        border-radius: 0.75rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .loading {
        padding: 3rem;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(8px);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
      }

      .loading .spinner-border {
        width: 3rem;
        height: 3rem;
        color: var(--primary-color);
      }

      .badge {
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-weight: 500;
        background: rgba(67, 97, 238, 0.1);
        color: var(--primary-color);
      }

      /* Add these additional styles */
      .card {
        height: 100%;
        margin-bottom: 0;
      }

      .features-container {
        background: transparent;
        padding: 0;
        margin-top: 0;
      }

      .alert-info {
        background: rgba(67, 97, 238, 0.05);
      }

      .alert-info ul {
        padding-left: 1.2rem;
      }

      .thumbnail-container {
        background: transparent;
        padding: 0;
        margin: 0;
      }

      .preview-container {
        background: transparent;
        padding: 0;
        margin: 0;
      }

      @media (max-width: 991.98px) {
        .col-lg-3, .col-lg-6 {
          margin-bottom: 1.5rem;
        }
      }

      /* Add styles for manual feature matching */
      .point-marker {
        position: absolute;
        width: 10px;
        height: 10px;
        background: rgba(255, 0, 0, 0.7);
        border: 2px solid white;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
      }

      .point-label {
        position: absolute;
        color: white;
        background: rgba(0, 0, 0, 0.7);
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 12px;
        transform: translate(-50%, -150%);
        pointer-events: none;
      }

      .image-container {
        position: relative;
        display: inline-block;
        cursor: crosshair;
      }

      .image-container img {
        max-width: 100%;
        height: auto;
      }

      #points1Container, #points2Container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="bi bi-image-alt me-2"></i>
          Image Feature Merger 
          <span class="badge ms-2">Beta v1.0.0</span>
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarContent">
          <ul class="navbar-nav ms-auto align-items-center">
            <li class="nav-item">
              <a class="nav-link" href="/view_files">
                <i class="bi bi-folder me-2"></i>File Browser
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/maintenance">
                <i class="bi bi-tools me-2"></i>Maintenance
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/ljh0311/PythonTools/tree/main/Image_Merger" target="_blank">
                <i class="bi bi-github me-2"></i>GitHub
              </a>
            </li>
            <li class="nav-item">
              <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
                <i class="bi bi-moon-fill"></i>
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row g-4">
        <!-- Left panel: Upload & Settings -->
        <div class="col-lg-3">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center">
              <i class="bi bi-gear-fill me-2"></i>
              <span>Upload & Settings</span>
            </div>
            <div class="card-body">
              <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-3">
                  <label for="images" class="form-label">Select Images (2 or more)</label>
                  <input type="file" class="form-control" id="images" name="images" multiple accept="image/jpeg,image/png,image/bmp,image/svg+xml" required />
                </div>

                <div class="mb-3">
                  <label class="form-label">Merge Type</label>
                  <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="merge_type" id="feature_merge" value="feature_merge" checked />
                    <label class="btn btn-outline-primary" for="feature_merge">Feature Merge</label>
                    <input type="radio" class="btn-check" name="merge_type" id="feature_aligned_blend" value="feature_aligned_blend" />
                    <label class="btn btn-outline-primary" for="feature_aligned_blend">Blend</label>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="threshold" class="form-label d-flex justify-content-between">
                    <span>Match Threshold</span>
                    <span class="badge" id="thresholdValue">0.7</span>
                  </label>
                  <input type="range" class="form-range" id="threshold" name="threshold" min="0.1" max="0.9" step="0.1" value="0.7" />
                </div>

                <div class="mb-3" id="alphaContainer">
                  <label for="alpha" class="form-label d-flex justify-content-between">
                    <span>Blend Transparency</span>
                    <span class="badge" id="alphaValue">0.5</span>
                  </label>
                  <input type="range" class="form-range" id="alpha" name="alpha" min="0.1" max="0.9" step="0.1" value="0.5" />
                </div>

                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" id="useOrb" name="use_orb" />
                  <label class="form-check-label" for="useOrb">Use ORB Detector</label>
                </div>

                <button type="submit" class="btn btn-primary w-100">
                  <i class="bi bi-magic me-2"></i>Process Images
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Middle panel: Features & Tips -->
        <div class="col-lg-3">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center">
              <i class="bi bi-tools me-2"></i>
              <span>Features & Tips</span>
            </div>
            <div class="card-body">
              <div class="features-container mb-4">
                <div class="d-grid gap-2">
                  <button class="btn btn-outline-primary" id="showMatchesBtn" disabled>
                    <i class="bi bi-link-45deg me-2"></i>Show Feature Matches
                  </button>
                  <button class="btn btn-outline-info" id="showPreprocessedBtn" disabled>
                    <i class="bi bi-image-alt me-2"></i>Show Preprocessed Image
                  </button>
                  <button class="btn btn-outline-success" id="manualMatchBtn" disabled>
                    <i class="bi bi-pencil me-2"></i>Manual Feature Matching
                  </button>
                  <button class="btn btn-outline-warning" id="enhancePanoramaBtn" disabled>
                    <i class="bi bi-magic me-2"></i>Enhance Panorama
                  </button>
                  <button class="btn btn-outline-secondary" id="tuneParamsBtn" disabled>
                    <i class="bi bi-sliders me-2"></i>Tune Parameters
                  </button>
                </div>
              </div>

              <!-- Parameter Tuning Modal -->
              <div class="modal fade" id="tuneParamsModal" tabindex="-1">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Tune Preprocessing Parameters</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <label for="nightThreshold" class="form-label d-flex justify-content-between">
                          <span>Night Threshold</span>
                          <span class="badge" id="nightThresholdValue">25</span>
                        </label>
                        <input type="range" class="form-range" id="nightThreshold" min="10" max="50" step="1" value="25" />
                      </div>
                      <div class="mb-3">
                        <label for="nightClaheLimit" class="form-label d-flex justify-content-between">
                          <span>Night CLAHE Limit</span>
                          <span class="badge" id="nightClaheLimitValue">2.0</span>
                        </label>
                        <input type="range" class="form-range" id="nightClaheLimit" min="1.0" max="4.0" step="0.1" value="2.0" />
                      </div>
                      <div class="mb-3">
                        <label for="normalClaheLimit" class="form-label d-flex justify-content-between">
                          <span>Normal CLAHE Limit</span>
                          <span class="badge" id="normalClaheLimitValue">1.5</span>
                        </label>
                        <input type="range" class="form-range" id="normalClaheLimit" min="1.0" max="3.0" step="0.1" value="1.5" />
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="button" class="btn btn-primary" id="applyTuningBtn">Apply & Process</button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="alert alert-info mb-0">
                <h6 class="alert-heading mb-2"><i class="bi bi-lightbulb me-2"></i>Tips for Better Results:</h6>
                <ul class="mb-0 small">
                  <li>Use images with at least 30% overlap</li>
                  <li>Try ORB detector for night images</li>
                  <li>Use 'Blend' mode for smoother transitions</li>
                  <li>Use 'Enhance Panorama' to fix crooked horizons</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Right panel: Results Preview -->
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <i class="bi bi-image me-2"></i>
                <span>Results Preview</span>
              </div>
              <div class="btn-group">
                <button id="downloadBtn" class="btn btn-sm btn-success" style="display: none;">
                  <i class="bi bi-download me-2"></i>Download
                </button>
                <button id="shareBtn" class="btn btn-sm btn-outline-primary" style="display: none;">
                  <i class="bi bi-share me-2"></i>Share
                </button>
              </div>
            </div>
            <div class="card-body">
              <div id="thumbnailsContainer" class="thumbnail-container mb-4">
                <div class="text-center text-muted p-4">
                  <i class="bi bi-images fs-2"></i>
                  <p class="mt-2">Upload 2 or more images to create a panorama</p>
                </div>
              </div>

              <div id="loading" class="loading" style="display: none;">
                <div class="spinner-border mb-3" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="lead mb-0">Processing your panorama...</p>
                <p class="text-muted small">This may take a few moments depending on image size</p>
              </div>

              <div id="result" class="preview-container" style="display: none;">
                <img id="previewImage" class="img-fluid rounded" alt="Panorama result">
              </div>

              <div id="errorContainer" class="alert alert-danger" style="display: none;" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span class="error-message"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual Feature Matching UI -->
    <div class="modal fade" id="manualMatchModal" tabindex="-1" aria-labelledby="manualMatchModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="manualMatchModalLabel">Manual Feature Matching</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <h6>Image 1 - Click to select points</h6>
                <div class="image-container">
                  <img id="manualImg1" src="" class="img-fluid border">
                  <div id="points1Container"></div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <h6>Image 2 - Click to select matching points</h6>
                <div class="image-container">
                  <img id="manualImg2" src="" class="img-fluid border">
                  <div id="points2Container"></div>
                </div>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-12">
                <div class="alert alert-info">
                  <p><strong>Instructions:</strong></p>
                  <ol>
                    <li>Click a point on Image 1</li>
                    <li>Click the corresponding point on Image 2</li>
                    <li>Repeat to create at least 4 matching pairs</li>
                    <li>Points should be in similar locations in both images</li>
                  </ol>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                  <div>Point pairs: <span id="pairCounter">0</span> <small class="text-muted">(minimum 4 required)</small></div>
                  <button id="clearPointsBtn" class="btn btn-outline-danger btn-sm">Clear Points</button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="processManualBtn" disabled>Process Images</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Make sure Bootstrap Bundle JS is included -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Global variables
      let uploadedFiles = []
      let resultImageUrl = null
      
      // UI References
      const uploadForm = document.getElementById('uploadForm')
      const imagesInput = document.getElementById('images')
      const thresholdSlider = document.getElementById('threshold')
      const thresholdValue = document.getElementById('thresholdValue')
      const alphaSlider = document.getElementById('alpha')
      const alphaValue = document.getElementById('alphaValue')
      const alphaContainer = document.getElementById('alphaContainer')
      const thumbnailsContainer = document.getElementById('thumbnailsContainer')
      const loading = document.getElementById('loading')
      const result = document.getElementById('result')
      const errorContainer = document.getElementById('errorContainer')
      const downloadBtn = document.getElementById('downloadBtn')
      const showMatchesBtn = document.getElementById('showMatchesBtn')
      const showPreprocessedBtn = document.getElementById('showPreprocessedBtn')
      const enhancePanoramaBtn = document.getElementById('enhancePanoramaBtn')
      const mergeTypeRadios = document.querySelectorAll('input[name="merge_type"]')
      const manualMatchBtn = document.getElementById('manualMatchBtn')
      const manualImg1 = document.getElementById('manualImg1')
      const manualImg2 = document.getElementById('manualImg2')
      const points1Container = document.getElementById('points1Container')
      const points2Container = document.getElementById('points2Container')
      const pairCount = document.getElementById('pairCount')
      const clearPointsBtn = document.getElementById('clearPointsBtn')
      const processManualBtn = document.getElementById('processManualBtn')
      const manualMatchModal = document.getElementById('manualMatchModal')
      const tuneParamsBtn = document.getElementById('tuneParamsBtn')
      const tuneParamsModal = document.getElementById('tuneParamsModal')
      const nightThresholdSlider = document.getElementById('nightThreshold')
      const nightThresholdValue = document.getElementById('nightThresholdValue')
      const nightClaheLimitSlider = document.getElementById('nightClaheLimit')
      const nightClaheLimitValue = document.getElementById('nightClaheLimitValue')
      const normalClaheLimitSlider = document.getElementById('normalClaheLimit')
      const normalClaheLimitValue = document.getElementById('normalClaheLimitValue')
      const applyTuningBtn = document.getElementById('applyTuningBtn')

      // Add event listeners for parameter sliders
      thresholdSlider.addEventListener('input', function(e) {
        thresholdValue.textContent = e.target.value
      })

      alphaSlider.addEventListener('input', function(e) {
        alphaValue.textContent = e.target.value
      })

      // Handle merge type change
      mergeTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          alphaContainer.style.display = this.value === 'feature_aligned_blend' ? 'block' : 'none'
        })
      })

      // Feature buttons event handlers
      showMatchesBtn.addEventListener('click', async function() {
        if (imagesInput.files.length < 2) {
          showError('Please upload at least 2 images first')
          return
        }

        loading.style.display = 'block'
        result.style.display = 'none'
        errorContainer.style.display = 'none'

        const formData = new FormData()
        for (let i = 0; i < imagesInput.files.length; i++) {
          formData.append('images', imagesInput.files[i])
        }
        formData.append('threshold', thresholdSlider.value)
        formData.append('use_orb', document.getElementById('useOrb').checked)

        try {
          const response = await fetch('/feature_matches', {
            method: 'POST',
            body: formData
          })

          if (!response.ok) {
            throw new Error('Network response was not ok')
          }

          const data = await response.json()

          if (data.success) {
            const img = document.createElement('img')
            img.src = data.result_image
            img.className = 'preview-image'
            img.alt = 'Feature Matches'
            result.innerHTML = ''
            result.appendChild(img)
            result.style.display = 'block'
          } else {
            showError(data.message || 'Failed to show feature matches')
          }
        } catch (error) {
          showError('Error showing feature matches: ' + error.message)
        } finally {
          loading.style.display = 'none'
        }
      })

      showPreprocessedBtn.addEventListener('click', async function() {
        if (imagesInput.files.length < 1) {
          showError('Please upload at least one image first')
          return
        }

        loading.style.display = 'block'
        result.style.display = 'none'
        errorContainer.style.display = 'none'

        const formData = new FormData()
        formData.append('image', imagesInput.files[0])

        try {
          const response = await fetch('/show_preprocessed', {
            method: 'POST',
            body: formData
          })

          if (!response.ok) {
            throw new Error('Network response was not ok')
          }

          const data = await response.json()

          if (data.success) {
            const img = document.createElement('img')
            img.src = data.result_image
            img.className = 'preview-image'
            img.alt = 'Preprocessed Image'
            result.innerHTML = ''
            result.appendChild(img)
            result.style.display = 'block'

            // Add image analysis info
            const infoDiv = document.createElement('div')
            infoDiv.className = 'mt-3 p-3 bg-light rounded'
            infoDiv.innerHTML = `
              <h6 class="mb-2">Image Analysis</h6>
              <p class="mb-1"><strong>Brightness:</strong> ${data.brightness_level}</p>
              <p class="mb-1"><strong>Contrast:</strong> ${data.contrast_level}</p>
              <p class="mb-1"><strong>Size:</strong> ${data.width}x${data.height}</p>
              <p class="mb-1"><strong>Processing Steps:</strong> ${data.processing_steps}</p>
              ${data.recommendations ? `<p class="mb-0"><strong>Recommendations:</strong> ${data.recommendations}</p>` : ''}
            `
            result.appendChild(infoDiv)
          } else {
            showError(data.message || 'Failed to show preprocessed image')
          }
        } catch (error) {
          showError('Error showing preprocessed image: ' + error.message)
        } finally {
          loading.style.display = 'none'
        }
      })

      enhancePanoramaBtn.addEventListener('click', async function() {
        if (!resultImageUrl) {
          showError('Please process images first')
          return
        }

        loading.style.display = 'block'
        result.style.display = 'none'
        errorContainer.style.display = 'none'

        const formData = new FormData()
        formData.append('image', await fetch(resultImageUrl).then(r => r.blob()))

        try {
          const response = await fetch('/enhance_panorama', {
            method: 'POST',
            body: formData
          })

          if (!response.ok) {
            throw new Error('Network response was not ok')
          }

          const data = await response.json()

          if (data.success) {
            const img = document.createElement('img')
            img.src = data.result_image
            img.className = 'preview-image'
            img.alt = 'Enhanced Panorama'
            result.innerHTML = ''
            result.appendChild(img)
            result.style.display = 'block'
            resultImageUrl = data.result_image

            // Enable download button
            downloadBtn.style.display = 'block'
            downloadBtn.onclick = function() {
              const a = document.createElement('a')
              a.href = data.result_image
              a.download = 'enhanced_panorama.jpg'
              document.body.appendChild(a)
              a.click()
              document.body.removeChild(a)
            }
          } else {
            showError(data.message || 'Failed to enhance panorama')
          }
        } catch (error) {
          showError('Error enhancing panorama: ' + error.message)
        } finally {
          loading.style.display = 'none'
        }
      })

      tuneParamsBtn.addEventListener('click', function() {
        const modal = new bootstrap.Modal(tuneParamsModal)
        modal.show()
      })

      // Handle form submission
      uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault()

        if (imagesInput.files.length < 2) {
          showError('Please select at least 2 images')
          return
        }

        // Reset UI
        loading.style.display = 'block'
        result.style.display = 'none'
        result.innerHTML = ''
        errorContainer.style.display = 'none'
        downloadBtn.style.display = 'none'
        showMatchesBtn.disabled = true
        showPreprocessedBtn.disabled = true
        manualMatchBtn.disabled = true
        enhancePanoramaBtn.disabled = true
        tuneParamsBtn.disabled = true

        // Create FormData
        const formData = new FormData()
        for (let i = 0; i < imagesInput.files.length; i++) {
          formData.append('images', imagesInput.files[i])
        }
        formData.append('merge_type', document.querySelector('input[name="merge_type"]:checked').value)
        formData.append('threshold', thresholdSlider.value)
        formData.append('alpha', alphaSlider.value)
        formData.append('use_orb', document.getElementById('useOrb').checked)

        try {
          const response = await fetch('/merge', {
            method: 'POST',
            body: formData
          })

          if (!response.ok) {
            throw new Error('Network response was not ok')
          }

          const data = await response.json()

          if (data.success) {
            // Display thumbnails
            thumbnailsContainer.innerHTML = ''
            data.thumbnails.forEach(thumb => {
              const div = document.createElement('div')
              div.className = 'thumbnail-item'
              div.innerHTML = `
                <img src="${thumb.url}" class="image-thumbnail" alt="Thumbnail">
                <button class="btn btn-sm btn-danger delete-thumbnail" data-index="${thumb.id}">
                  <i class="bi bi-trash"></i>
                </button>
              `
              thumbnailsContainer.appendChild(div)
            })

            // Display result
            const img = document.createElement('img')
            img.src = data.result_image
            img.className = 'preview-image'
            img.alt = 'Panorama result'
            result.appendChild(img)
            result.style.display = 'block'
            resultImageUrl = data.result_image

            // Enable buttons
            showMatchesBtn.disabled = false
            showPreprocessedBtn.disabled = false
            manualMatchBtn.disabled = false
            enhancePanoramaBtn.disabled = false
            tuneParamsBtn.disabled = false

            // Show download button
            downloadBtn.style.display = 'block'
            downloadBtn.onclick = function() {
              const a = document.createElement('a')
              a.href = data.result_image
              a.download = 'panorama.jpg'
              document.body.appendChild(a)
              a.click()
              document.body.removeChild(a)
            }
          } else {
            showError(data.message || 'Failed to process images')
          }
        } catch (error) {
          showError('Error processing images: ' + error.message)
        } finally {
          loading.style.display = 'none'
        }
      })

      // Helper function to display errors
      function showError(message) {
        errorContainer.querySelector('.error-message').textContent = message
        errorContainer.style.display = 'block'
      }

      // Manual feature matching functionality
      document.addEventListener('DOMContentLoaded', function() {
        const manualMatchBtn = document.getElementById('manualMatchBtn');
        const manualImg1 = document.getElementById('manualImg1');
        const manualImg2 = document.getElementById('manualImg2');
        const points1Container = document.getElementById('points1Container');
        const points2Container = document.getElementById('points2Container');
        const pairCounter = document.getElementById('pairCounter');
        const clearPointsBtn = document.getElementById('clearPointsBtn');
        const processManualBtn = document.getElementById('processManualBtn');
        const manualMatchModal = document.getElementById('manualMatchModal');

        let pointPairs = [];
        let waitingForSecondClick = false;
        let tempPoint = null;

        // Initialize the modal
        const modal = new bootstrap.Modal(manualMatchModal);

        manualMatchBtn.addEventListener('click', function() {
          if (imagesInput.files.length < 2) {
            showError('Please upload at least 2 images first');
            return;
          }

          // Reset state
          resetManualMatchState();
          
          // Load images into the modal
          const reader1 = new FileReader();
          reader1.onload = function(e) {
            manualImg1.src = e.target.result;
          };
          reader1.readAsDataURL(imagesInput.files[0]);

          const reader2 = new FileReader();
          reader2.onload = function(e) {
            manualImg2.src = e.target.result;
          };
          reader2.readAsDataURL(imagesInput.files[1]);

          // Show the modal
          modal.show();
        });

        function resetManualMatchState() {
          pointPairs = [];
          waitingForSecondClick = false;
          tempPoint = null;
          points1Container.innerHTML = '';
          points2Container.innerHTML = '';
          pairCounter.textContent = '0';
          processManualBtn.disabled = true;
        }

        // Handle clicking on images
        manualImg1.parentElement.addEventListener('click', function(e) {
          if (waitingForSecondClick) return;

          const rect = manualImg1.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;

          tempPoint = {x, y};
          waitingForSecondClick = true;

          // Add visual marker
          addPointMarker(points1Container, x, y, pointPairs.length + 1);
        });

        manualImg2.parentElement.addEventListener('click', function(e) {
          if (!waitingForSecondClick) return;

          const rect = manualImg2.getBoundingClientRect();
          const x = (e.clientX - rect.left) / rect.width;
          const y = (e.clientY - rect.top) / rect.height;

          // Add visual marker
          addPointMarker(points2Container, x, y, pointPairs.length + 1);

          // Add the point pair
          pointPairs.push({
            img1: tempPoint,
            img2: {x, y}
          });

          // Reset state for next pair
          waitingForSecondClick = false;
          tempPoint = null;

          // Update counter and button state
          pairCounter.textContent = pointPairs.length.toString();
          processManualBtn.disabled = pointPairs.length < 4;
        });

        function addPointMarker(container, x, y, number) {
          const marker = document.createElement('div');
          marker.className = 'point-marker';
          marker.style.left = `${x * 100}%`;
          marker.style.top = `${y * 100}%`;

          const label = document.createElement('div');
          label.className = 'point-label';
          label.textContent = number;
          label.style.left = `${x * 100}%`;
          label.style.top = `${y * 100}%`;

          container.appendChild(marker);
          container.appendChild(label);
        }

        // Clear points button
        clearPointsBtn.addEventListener('click', resetManualMatchState);

        // Process manual points button
        processManualBtn.addEventListener('click', function() {
          if (pointPairs.length < 4) {
            showError('Please select at least 4 point pairs');
            return;
          }

          // Hide the modal
          modal.hide();

          // Show loading indicator
          loading.style.display = 'block';
          result.style.display = 'none';
          errorContainer.style.display = 'none';

          // Create FormData with the images and point pairs
          const formData = new FormData();
          formData.append('image1', imagesInput.files[0]);
          formData.append('image2', imagesInput.files[1]);
          formData.append('point_pairs', JSON.stringify(pointPairs));

          // Send to server
          fetch('/process_manual_points', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            loading.style.display = 'none';

            if (data.success) {
              // Display the result
              const img = document.createElement('img');
              img.src = data.result_image;
              img.className = 'preview-image';
              img.alt = 'Manual Match Result';
              result.innerHTML = '';
              result.appendChild(img);
              result.style.display = 'block';

              // Enable download button
              downloadBtn.style.display = 'block';
              downloadBtn.onclick = function() {
                const a = document.createElement('a');
                a.href = data.result_image;
                a.download = 'manual_match_result.jpg';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
              };
            } else {
              showError(data.message || 'Failed to process manual points');
            }
          })
          .catch(error => {
            loading.style.display = 'none';
            showError('Error processing manual points: ' + error.message);
          });
        });
      });

      // Add CSS for delete buttons
      const style = document.createElement('style')
      style.textContent = `
        .thumbnail-item {
          position: relative;
        }
        .delete-thumbnail {
          display: none;
          z-index: 10;
        }
        .thumbnail-item:hover .delete-thumbnail {
          display: block;
        }
        .delete-result {
          opacity: 0;
          transition: opacity 0.2s;
        }
        .preview-container:hover .delete-result {
          opacity: 1;
        }
      `
      document.head.appendChild(style)

      // Handle result image deletion
      document.querySelector('.delete-result').addEventListener('click', async function() {
        if (!resultImageUrl) return
        
        try {
          const response = await fetch('/delete_file', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              file_path: resultImageUrl
            })
          })
          
          const data = await response.json()
          if (data.success) {
            // Clear the result container
            result.style.display = 'none'
            result.innerHTML = ''
            resultImageUrl = null
            downloadBtn.style.display = 'none'
            enhancePanoramaBtn.disabled = true
          } else {
            showError(data.message || 'Failed to delete file')
          }
        } catch (error) {
          showError('Error deleting file: ' + error.message)
        }
      })

      // Theme toggle functionality
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = themeToggle.querySelector('i');
      
      // Check for saved theme preference or default to light
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
      
      themeToggle.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      });
      
      function updateThemeIcon(theme) {
        themeIcon.className = theme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
      }
    </script>

    
  </body>
</html>
